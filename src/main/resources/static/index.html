<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>User Profile Stream & Management</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-light">

<nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
    <div class="container-fluid">
        <a class="navbar-brand" href="#">ProfilePulse</a>
    </div>
</nav>

<div class="container">
    <!-- Streaming Section -->
    <div class="card mb-4">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0">Live User Profile Stream</h5>
        </div>
        <div class="card-body">
            <form id="streamForm" class="row g-3">
                <div class="col-md-2">
                    <label for="minAge" class="form-label">Min Age</label>
                    <input type="number" class="form-control" id="minAge" min="0">
                </div>
                <div class="col-md-2">
                    <label for="maxAge" class="form-label">Max Age</label>
                    <input type="number" class="form-control" id="maxAge" min="0">
                </div>
                <div class="col-md-2">
                    <label for="minBonus" class="form-label">Min Bonus</label>
                    <input type="number" class="form-control" id="minBonus" min="0">
                </div>
                <div class="col-md-2">
                    <label for="bloodGroup" class="form-label">Blood Group</label>
                    <input type="text" class="form-control" id="bloodGroup" placeholder="e.g. A+, O-">
                </div>
                <div class="col-md-2">
                    <label for="minWeight" class="form-label">Min Weight (kg)</label>
                    <input type="number" class="form-control" id="minWeight" min="0" step="0.1">
                </div>
                <div class="col-md-4 d-flex align-items-end">
                    <button type="button" class="btn btn-success me-2" onclick="startStream()">Start Stream</button>
                    <button type="button" class="btn btn-secondary" onclick="stopStream()">Stop Stream</button>
                </div>
            </form>
            <div id="streamAlert" class="mt-3"></div>
            <div id="streamOutput" class="mt-3" style="max-height: 200px; overflow-y: auto;"></div>
        </div>
    </div>

    <!-- User Management Section -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <h5 class="mb-0">User Profiles</h5>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">Add New User</button>
    </div>
    <div id="userAlert"></div>
    <div id="usersList" class="row"></div>
</div>

<!-- Create User Modal -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="createUserForm" onsubmit="submitCreateUser(event)">
      <div class="modal-header">
        <h5 class="modal-title" id="createUserModalLabel">Create New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- User fields -->
        <div class="mb-2">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="createName" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Age</label>
          <input type="number" class="form-control" id="createAge" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Bonus</label>
          <input type="number" class="form-control" id="createBonus" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Height (cm)</label>
          <input type="number" class="form-control" id="createHeight" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Weight (kg)</label>
          <input type="number" class="form-control" id="createWeight" min="0" step="0.1" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Blood Group</label>
          <input type="text" class="form-control" id="createBlood" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Favorite Color</label>
          <input type="text" class="form-control" id="createColor" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Company</label>
          <input type="text" class="form-control" id="createCompany">
        </div>
        <!-- Add more fields as needed -->
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Create</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Update User Modal -->
<div class="modal fade" id="updateUserModal" tabindex="-1" aria-labelledby="updateUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form class="modal-content" id="updateUserForm" onsubmit="submitUpdateUser(event)">
      <div class="modal-header">
        <h5 class="modal-title" id="updateUserModalLabel">Update User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <!-- User fields (same as create, but with update IDs) -->
        <input type="hidden" id="updateId">
        <div class="mb-2">
          <label class="form-label">Name</label>
          <input type="text" class="form-control" id="updateName" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Age</label>
          <input type="number" class="form-control" id="updateAge" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Bonus</label>
          <input type="number" class="form-control" id="updateBonus" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Height (cm)</label>
          <input type="number" class="form-control" id="updateHeight" min="0" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Weight (kg)</label>
          <input type="number" class="form-control" id="updateWeight" min="0" step="0.1" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Blood Group</label>
          <input type="text" class="form-control" id="updateBlood" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Favorite Color</label>
          <input type="text" class="form-control" id="updateColor" required>
        </div>
        <div class="mb-2">
          <label class="form-label">Company</label>
          <input type="text" class="form-control" id="updateCompany">
        </div>
        <!-- Add more fields as needed -->
      </div>
      <div class="modal-footer">
        <button type="submit" class="btn btn-success">Update</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Bootstrap JS Bundle (includes Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let eventSource;

    // Stream logic
    function startStream() {
        const minAge = document.getElementById('minAge').value;
        const maxAge = document.getElementById('maxAge').value;
        const minBonus = document.getElementById('minBonus').value;
        const bloodGroup = document.getElementById('bloodGroup').value;
        const minWeight = document.getElementById('minWeight').value;

        let url = '/api/users/stream';
        const params = new URLSearchParams();

        if (minAge) params.append('minAge', minAge);
        if (maxAge) params.append('maxAge', maxAge);
        if (minBonus) params.append('minBonus', minBonus);
        if (bloodGroup) params.append('bloodGroup', bloodGroup);
        if (minWeight) params.append('minWeight', minWeight);

        if (params.toString()) {
            url += '?' + params.toString();
        }

        if (eventSource) eventSource.close();
        document.getElementById('streamOutput').innerHTML = '';
        document.getElementById('streamAlert').innerHTML = '';

        eventSource = new EventSource(url);

        eventSource.onmessage = function(event) {
            const user = JSON.parse(event.data);
            const output = document.getElementById('streamOutput');

            if (user.name === "Error") {
                showStreamAlert('An error occurred while streaming data.', 'danger');
            } else {
                output.innerHTML += `
                    <div class="alert alert-secondary p-2 mb-1">
                        <strong>${user.name}</strong> (Age: ${user.age}, Bonus: ${user.bonus}, BMI: ${user.bmi ? user.bmi.toFixed(1) : '-'}<br>
                        Height: ${user.height || '-'} cm, Weight: ${user.weight || '-'} kg, Blood: ${user.blood || '-'}, Color: ${user.color || '-'}
                        )
                    </div>
                `;
            }
            output.scrollTop = output.scrollHeight;
        };

        eventSource.onerror = function() {
            showStreamAlert('Stream connection error.', 'danger');
            eventSource.close();
        };
    }

    function stopStream() {
        if (eventSource) {
            eventSource.close();
            document.getElementById('streamOutput').innerHTML += '<div class="alert alert-warning">Stream stopped</div>';
        }
    }

    function showStreamAlert(message, type) {
        document.getElementById('streamAlert').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
    }

    // CRUD logic
    function fetchUsers() {
        axios.get('/api/users')
            .then(response => {
                const usersList = document.getElementById('usersList');
                usersList.innerHTML = '';
                response.data.forEach(user => {
                    usersList.innerHTML += `
                        <div class="col-md-4">
                            <div class="card mb-3">
                                <div class="card-body">
                                    <h5 class="card-title">${user.name}</h5>
                                    <p class="card-text">
                                        <strong>Age:</strong> ${user.age}<br>
                                        <strong>Bonus:</strong> ${user.bonus}<br>
                                        <strong>Height:</strong> ${user.height || '-'} cm<br>
                                        <strong>Weight:</strong> ${user.weight || '-'} kg<br>
                                        <strong>Blood Group:</strong> ${user.blood || '-'}<br>
                                        <strong>Favorite Color:</strong> ${user.color || '-'}<br>
                                        <strong>BMI:</strong> ${user.bmi ? user.bmi.toFixed(1) : '-'}<br>
                                        <strong>Company:</strong> ${user.company || '-'}
                                    </p>
                                    <button class="btn btn-sm btn-outline-primary me-2" onclick="openUpdateModal('${user.id}', '${user.name}', ${user.age}, ${user.bonus}, ${user.height || 0}, ${user.weight || 0}, '${user.blood || ''}', '${user.color || ''}', '${user.company || ''}')">Edit</button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="deleteUser('${user.id}')">Delete</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            })
            .catch(error => {
                showUserAlert('Error fetching users.', 'danger');
            });
    }

    function showUserAlert(message, type) {
        document.getElementById('userAlert').innerHTML = `<div class="alert alert-${type}">${message}</div>`;
        setTimeout(() => { document.getElementById('userAlert').innerHTML = ''; }, 3000);
    }

    // Create User
    function submitCreateUser(event) {
        event.preventDefault();
        const user = {
            name: document.getElementById('createName').value,
            age: parseInt(document.getElementById('createAge').value),
            bonus: parseInt(document.getElementById('createBonus').value),
            height: parseInt(document.getElementById('createHeight').value),
            weight: parseFloat(document.getElementById('createWeight').value),
            blood: document.getElementById('createBlood').value,
            color: document.getElementById('createColor').value,
            company: document.getElementById('createCompany').value,
            bmi: 0 // Will be recalculated on backend
        };
        axios.post('/api/users', user)
            .then(() => {
                fetchUsers();
                showUserAlert('User created successfully.', 'success');
                document.getElementById('createUserForm').reset();
                var modal = bootstrap.Modal.getInstance(document.getElementById('createUserModal'));
                modal.hide();
            })
            .catch(() => {
                showUserAlert('Error creating user.', 'danger');
            });
    }

    // Update User
    function openUpdateModal(id, name, age, bonus, height, weight, blood, color, company) {
        document.getElementById('updateId').value = id;
        document.getElementById('updateName').value = name;
        document.getElementById('updateAge').value = age;
        document.getElementById('updateBonus').value = bonus;
        document.getElementById('updateHeight').value = height;
        document.getElementById('updateWeight').value = weight;
        document.getElementById('updateBlood').value = blood;
        document.getElementById('updateColor').value = color;
        document.getElementById('updateCompany').value = company;
        var modal = new bootstrap.Modal(document.getElementById('updateUserModal'));
        modal.show();
    }

    function submitUpdateUser(event) {
        event.preventDefault();
        const id = document.getElementById('updateId').value;
        const user = {
            name: document.getElementById('updateName').value,
            age: parseInt(document.getElementById('updateAge').value),
            bonus: parseInt(document.getElementById('updateBonus').value),
            height: parseInt(document.getElementById('updateHeight').value),
            weight: parseFloat(document.getElementById('updateWeight').value),
            blood: document.getElementById('updateBlood').value,
            color: document.getElementById('updateColor').value,
            company: document.getElementById('updateCompany').value,
            bmi: 0 // Will be recalculated on backend
        };
        axios.put(`/api/users/${id}`, user)
            .then(() => {
                fetchUsers();
                showUserAlert('User updated successfully.', 'success');
                var modal = bootstrap.Modal.getInstance(document.getElementById('updateUserModal'));
                modal.hide();
            })
            .catch(() => {
                showUserAlert('Error updating user.', 'danger');
            });
    }

    // Delete User
    function deleteUser(id) {
        // if (!confirm('Are you sure you want to delete this user?')) return;
        axios.delete(`/api/users/${id}`)
            .then(() => {
                fetchUsers();
                showUserAlert('User deleted successfully.', 'success');
            })
            .catch(() => {
                showUserAlert('Error deleting user.', 'danger');
            });
    }

    // Initial load
    fetchUsers();
</script>
</body>
</html>